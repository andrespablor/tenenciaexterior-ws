<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - AppAnn</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/auth.css?v=3.99.02">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="auth-modal" class="show">
        <div class="auth-modal-content">
            <!-- Header con Logo -->
            <div class="auth-header">
                <div class="auth-logo">
                    <img src="assets/appann-logo.png" alt="AppAnn Logo"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <!-- Fallback si no existe la imagen -->
                    <div style="display:none; font-size: 48px; font-weight: 800; 
                                background: linear-gradient(135deg, #0ea5e9, #06b6d4);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;">
                        A
                    </div>
                </div>
                <h2 class="auth-title" id="mode-title">AppAnn</h2>
                <p class="auth-subtitle" id="mode-subtitle">Ingresá a tu cuenta</p>
            </div>

            <!-- Body con Formulario -->
            <div class="auth-modal-body">
                <div class="auth-error" id="error-msg" style="display: none;"></div>
                <div class="auth-error success" id="success-msg" style="display: none;"></div>

                <form id="auth-form">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="tu@email.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" placeholder="••••••••" minlength="6" required
                            autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn-full" id="submit-btn">Ingresar</button>
                </form>

                <div class="auth-switch">
                    <span id="switch-text">¿No tenés cuenta?</span>
                    <button type="button" class="btn-link" id="switch-btn">Registrate</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://wqjnjewadakatnpwfcpf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxam5qZXdhZGFrYXRucHdmY3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMDAwNDEsImV4cCI6MjA4MzU3NjA0MX0.qTJrBdJoS0yWhhpCf0RjUI7v-eHKLPu9S90aQ7HQFi4';

        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLoginMode = true;

        // Elements
        const form = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const submitBtn = document.getElementById('submit-btn');
        const switchBtn = document.getElementById('switch-btn');
        const switchText = document.getElementById('switch-text');
        const modeTitle = document.getElementById('mode-title');
        const modeSubtitle = document.getElementById('mode-subtitle');
        const errorMsg = document.getElementById('error-msg');
        const successMsg = document.getElementById('success-msg');

        // Check if already logged in
        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session?.user) {
                window.location.href = 'index.html';
            }
        }
        checkSession();

        // Switch mode
        switchBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            hideMessages();

            if (isLoginMode) {
                modeSubtitle.textContent = 'Ingresá a tu cuenta';
                submitBtn.textContent = 'Ingresar';
                switchText.textContent = '¿No tenés cuenta?';
                switchBtn.textContent = 'Registrate';
            } else {
                modeSubtitle.textContent = 'Creá tu cuenta';
                submitBtn.textContent = 'Registrarse';
                switchText.textContent = '¿Ya tenés cuenta?';
                switchBtn.textContent = 'Iniciá sesión';
            }
        });

        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();

            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                showError('Por favor completá todos los campos');
                return;
            }

            if (password.length < 6) {
                showError('La contraseña debe tener al menos 6 caracteres');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Procesando...';

            try {
                let result;
                if (isLoginMode) {
                    result = await _supabase.auth.signInWithPassword({ email, password });
                } else {
                    result = await _supabase.auth.signUp({ email, password });
                }

                if (result.error) {
                    showError(translateError(result.error.message));
                    resetButton();
                    return;
                }

                if (!isLoginMode && !result.data.session) {
                    showSuccess('✅ Cuenta creada! Revisá tu email para confirmar.');
                    resetButton();
                    return;
                }

                // Success - redirect
                showSuccess('✅ Bienvenido! Redirigiendo...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } catch (error) {
                showError('Error inesperado. Intentá de nuevo.');
                resetButton();
            }
        });

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.add('error');
            errorMsg.classList.remove('success');
            errorMsg.style.display = 'block';
            successMsg.style.display = 'none';
        }

        function showSuccess(msg) {
            successMsg.textContent = msg;
            successMsg.classList.add('success');
            successMsg.classList.remove('error');
            successMsg.style.display = 'block';
            errorMsg.style.display = 'none';
        }

        function hideMessages() {
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        }

        function resetButton() {
            submitBtn.disabled = false;
            submitBtn.textContent = isLoginMode ? 'Ingresar' : 'Registrarse';
        }

        function translateError(error) {
            const translations = {
                'Invalid login credentials': 'Email o contraseña incorrectos',
                'Email not confirmed': 'Necesitás confirmar tu email primero',
                'User already registered': 'Este email ya está registrado',
                'Password should be at least 6 characters': 'La contraseña debe tener al menos 6 caracteres',
                'Unable to validate email address: invalid format': 'Formato de email inválido',
                'Email rate limit exceeded': 'Demasiados intentos. Esperá un momento.',
                'Signup requires a valid password': 'Ingresá una contraseña válida'
            };
            return translations[error] || error || 'Error desconocido';
        }
    </script>
</body>

</html>